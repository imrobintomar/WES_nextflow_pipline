{% extends "base.html" %}

{% block title %}Upload Files{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-upload"></i> Upload Exome Sequencing Files</h4>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Upload your paired-end FASTQ files (.fastq.gz) to start whole exome sequencing analysis.
                    The pipeline will perform quality control, alignment, variant calling, and annotation.
                </p>

                <form action="{{ url_for('upload_files') }}" method="post" enctype="multipart/form-data" id="uploadForm">
                    <div class="upload-area" id="dropZone">
                        <div class="upload-icon">
                            <i class="bi bi-cloud-arrow-up display-1 text-primary"></i>
                        </div>
                        <h5>Drag & Drop your FASTQ files here</h5>
                        <p class="text-muted">or click to browse</p>
                        <input type="file" name="files" id="fileInput" multiple
                               accept=".fastq,.fq,.fastq.gz,.fq.gz,.gz" class="d-none">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="bi bi-folder2-open"></i> Browse Files
                        </button>
                    </div>

                    <div id="fileList" class="mt-3" style="display: none;">
                        <h6><i class="bi bi-files"></i> Selected Files:</h6>
                        <ul class="list-group" id="selectedFiles"></ul>
                        <div class="mt-2">
                            <span class="badge bg-info" id="fileCount">0 files</span>
                            <span class="badge bg-secondary" id="totalSize">0 MB</span>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary btn-lg w-100" id="uploadBtn" disabled>
                            <i class="bi bi-cloud-upload"></i> Upload and Continue
                        </button>
                    </div>
                </form>

                <hr>

                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="feature-box">
                            <i class="bi bi-file-earmark-code display-4 text-primary"></i>
                            <h6 class="mt-2">Supported Formats</h6>
                            <small class="text-muted">.fastq.gz, .fq.gz<br>Paired-end reads</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-box">
                            <i class="bi bi-hdd display-4 text-success"></i>
                            <h6 class="mt-2">Max File Size</h6>
                            <small class="text-muted">50 GB total<br>per analysis</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-box">
                            <i class="bi bi-shield-check display-4 text-info"></i>
                            <h6 class="mt-2">Secure Processing</h6>
                            <small class="text-muted">Data encrypted<br>and protected</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Pipeline Overview</h5>
            </div>
            <div class="card-body">
                <div class="pipeline-steps">
                    <div class="step">
                        <span class="step-number">1</span>
                        <span class="step-name">fastp</span>
                        <small>Quality Control</small>
                    </div>
                    <div class="step-arrow"><i class="bi bi-arrow-right"></i></div>
                    <div class="step">
                        <span class="step-number">2</span>
                        <span class="step-name">BWA-MEM2</span>
                        <small>Alignment</small>
                    </div>
                    <div class="step-arrow"><i class="bi bi-arrow-right"></i></div>
                    <div class="step">
                        <span class="step-number">3</span>
                        <span class="step-name">GATK</span>
                        <small>Preprocessing</small>
                    </div>
                    <div class="step-arrow"><i class="bi bi-arrow-right"></i></div>
                    <div class="step">
                        <span class="step-number">4</span>
                        <span class="step-name">HaplotypeCaller</span>
                        <small>Variant Calling</small>
                    </div>
                    <div class="step-arrow"><i class="bi bi-arrow-right"></i></div>
                    <div class="step">
                        <span class="step-number">5</span>
                        <span class="step-name">ANNOVAR</span>
                        <small>Annotation</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const selectedFiles = document.getElementById('selectedFiles');
const uploadBtn = document.getElementById('uploadBtn');
const fileCount = document.getElementById('fileCount');
const totalSize = document.getElementById('totalSize');

// Drag and drop handlers
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    fileInput.files = e.dataTransfer.files;
    updateFileList();
});

dropZone.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', updateFileList);

function updateFileList() {
    const files = fileInput.files;
    selectedFiles.innerHTML = '';

    if (files.length === 0) {
        fileList.style.display = 'none';
        uploadBtn.disabled = true;
        return;
    }

    let total = 0;
    for (let file of files) {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
            <span><i class="bi bi-file-earmark-text"></i> ${file.name}</span>
            <span class="badge bg-primary">${formatSize(file.size)}</span>
        `;
        selectedFiles.appendChild(li);
        total += file.size;
    }

    fileList.style.display = 'block';
    fileCount.textContent = `${files.length} file${files.length > 1 ? 's' : ''}`;
    totalSize.textContent = formatSize(total);
    uploadBtn.disabled = false;
}

function formatSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Show progress on upload
document.getElementById('uploadForm').addEventListener('submit', function() {
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';
});
</script>
{% endblock %}
